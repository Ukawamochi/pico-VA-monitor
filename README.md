# pico-va-monitor（RP2040 × INA219）

Raspberry Pi Pico / Pico W（RP2040）と INA219 による**電圧・電流・電力**モニタです。いまは「最小構成」として、500 ms 周期で `defmt` ログに**V/I/P の数値のみ**を出力します（グラフや集計は無効化）。

- HAL: `rp2040-hal`（安定版）
- ログ: `defmt` + `defmt-rtt`
- パニック: `panic-probe`（`print-defmt`有効）
- I²C: 100 kHz（I2C0 / GPIO4,5、外部プルアップ必須）
- 計測周期: 500 ms（実測Δtで積分）
- 依存: `embedded-hal`, `ina219`（sync機能）, `fugit`

## 配線（Pico ピン表記）

- I2C0 SDA = GPIO4（ピン6）
- I2C0 SCL = GPIO5（ピン7）
- 3V3 ↔ VCC、GND ↔ GND
- シャント抵抗例: **0.1 Ω**（ブレークアウト基板の一般的既定）
- 被測定回路の向き: **VIN+ が電源側、VIN− が負荷側**

### 初心者向け: 3V3 と VCC の意味

- 3V3（3.3V）は Raspberry Pi Pico の電源出力ピンの一つで、Pico 本体のロジック電圧も 3.3V です。
- VCC は部品（今回は INA219 ブレイクアウト）の電源入力を指す一般的な呼び名です。多くのブレイクアウト基板は VCC と表記されています。
- INA219 ブレイクアウトは 2.7V〜5.5V で動作しますが、基板上の I2C プルアップは VCC に接続されている場合が多いので、Pico と直結するなら VCC に **3V3（Pico の 3.3V 出力）を接続してください。**
- もし VCC を 5V にするとブレイクアウトの SDA/SCL に 5V のプルアップがかかり、Pico の I/O を壊す可能性があります（レベル変換がない場合）。

### 注意: VIN+ / VIN− の使い方

- VIN+ / VIN− は被測定回路の電流を測るための入力で、通常は被測定回路の「電源側」と「負荷側」を直列に接続します。
- VIN+ は電源側（例: バッテリの＋）、VIN− は負荷側（例: モータや回路の＋）に接続します。GND は必ず Pico と共通にしてください。VIN+/VIN− は INA219 の測定経路で、ここに電源を入れると基板上のシャント抵抗を経由して電流が測れます。

### VIN の対応電圧・電流（チップとブレイクアウトの目安）

- バス電圧（INA219 が計測できる電圧）: INA219 チップは最大約 **26 V** までのバス電圧を計測できます。つまり VIN+ / VIN− と基板 GND 間の電位が 26V を超えない範囲で使用してください。
- シャント電圧（差動）: INA219 の内部増幅器と PGA により、シャント両端の最大差動電圧は **±320 mV**（ゲイン最大設定時）です。これはソフト/ハード両方でのゲイン設定に依存します。
- シャント抵抗と対応電流の例: 本リポジトリでは **0.1 Ω** を想定しています。シャント差動 ±320 mV とすると理論上の最大電流は

  I_max = 0.320 V / 0.1 Ω = 3.2 A

  となります。ただしこれは理想値です。
- シャントの発熱（重要）: シャントに流れる電流 I による損失は P = I^2 × R です。例:
  - I = 3.2 A, R = 0.1 Ω のとき P ≈ 1.02 W（高温になります）
  - I = 2.0 A, R = 0.1 Ω のとき P = 0.4 W

  ブレイクアウト基板付属の小さなシャントや基板の銅パターンは高い電力を連続で扱うようには設計されていない場合があります。長時間にわたり大きな電流（数 A）を測る場合は、実際のシャント抵抗を放熱性の高いものに交換するか、より大きな外付けシャントを使用してください。
- ブレイクアウト基板の実用上の制限: Adafruit 等の一般的な INA219 ブレイクアウトは設計上 **数百 mA〜数 A** の計測を狙っていますが、基板ごとに実測可能な最大電流や安全マージンは異なります。基板のドキュメントで最大定格や推奨使用法（PGA / ゲイン設定）を確認してください。
- ソフト側の設定との関係: `src/main.rs` の `init_ina219` で設定している `ShuntVoltageRange::GainDiv8`（PGA）や ADC 平均化は、測定範囲と分解能に影響します。高電流を扱うときはゲイン/レンジ設定とシャントの組合せ（電力損失）を見直してください。

以上を踏まえ、使うシャント抵抗値・測定レンジ・連続通電時の発熱を考慮して安全な構成で接続してください。

## ビルド

```bash
rustup target add thumbv6m-none-eabi
cargo build --release
```

`DEFMT_LOG` の推奨設定（VSCode 例）:

```jsonc
// .vscode/tasks.json
{
  "label": "cargo build (thumbv6m)",
  "options": { "env": { "DEFMT_LOG": "info" } }
}
// .vscode/launch.json
{
  "env": { "DEFMT_LOG": "info" },
  "coreConfigs": [{ "rttEnabled": true, "rttChannelFormats": [{"dataFormat": "Defmt"}] }]
}
```

## 書き込み・実行例

- probe-rs（RTT で defmt 確認）
  ```bash
  probe-rs run --chip RP2040 --release
  ```
- UF2（BOOTSEL ドラッグ&ドロップ）
  ```bash
  elf2uf2-rs target/thumbv6m-none-eabi/release/pico-va-monitor
  # 生成された .uf2 を RPI-RP2 にコピー
  ```

## 調整可能な定数（最小構成）

- `src/main.rs`
  - `SHUNT_OHMS`（シャント抵抗 [Ω]、例: 0.1）
  - `MAX_EXPECTED_AMPS`（最大期待電流 [A]、例: 2.0）

校正は `ina219::IntCalibration` を使用し、`SHUNT_OHMS` と `MAX_EXPECTED_AMPS` から `current_LSB`（µA/bit）を算出して適用します。I2C アドレスはよくある候補（0x40/0x41/0x44/0x45/0x48/0x4C）を自動的に順番に試します。

## INA219 の I2C アドレスを変える方法（ハード側 / ソフト側）

1) ハード側（ブレイクアウトの A0 / A1 ジャンパ）

- 多くの INA219 ブレイクアウト（Adafruit 等）には A0 と A1 のサーマブルジャンパ（またはハンダパッド）があり、これを GND / VCC / SDA / SCL に接続してアドレスを切り替えます。
- Adafruit の一般的なマッピング（参考）:
  - デフォルト（A0=GND, A1=GND） = 0x40
  - A0 を VCC に接続（A0=VCC, A1=GND） = 0x41
  - A1 を VCC に接続（A0=GND, A1=VCC） = 0x44
  - A0 と A1 を両方 VCC にすると = 0x45

  （ブレイクアウトのドキュメントを必ず確認してください。ボードによっては接続先のラベルが異なります。）

2) ソフト側（このリポジトリの挙動）

- `src/main.rs` の初期化で、よくあるアドレス候補（0x40/0x41/0x44/0x45/0x48/0x4C）を自動的に順番に試し、最初に成功したアドレスを採用します。ジャンパ変更後でも基本はそのまま動く想定です。
- 特定のアドレスだけに固定したい場合は、`init_ina219_auto` の候補配列を1個に絞るか、固定アドレス版の初期化に書き換えてください。

## 表示例（defmt、最小構成）

```
V=5.02 V  I=128.7 mA  P=646.5 mW
```

## 電池本数換算の前提

- AA: 代表値 ≈ **2.5 Wh**
- AAA: 代表値 ≈ **1.1 Wh**

実容量はメーカー・負荷・温度依存で変動します。目安表示としてご利用ください。

## ノイズ・安定化のヒント

- 平均回数（`Resolution::Avg128` 以上）と変換時間を適切に設定
- PGA（`ShuntVoltageRange`）を用途に合わせて選択（大電流で飽和しない設定）
- 配線を短くし、GND リターンを共有しすぎない
- 微小電流カットオフを適宜調整（積算の誤差抑制）

## 永続化について

フラッシュ寿命の観点から、本初期版では累計のフラッシュ保存は未対応です。長期ログの永続化が必要な場合は外部 **FRAM** の利用や、ホスト側での収集を推奨します。

## 既知の注意

- `ina219` クレートの API 名称（`SyncIna219`, `IntCalibration`, `next_measurement()` 等）は利用バージョンにより差異がある場合があります。最新版に合わせて `Cargo.toml` のバージョンを調整してください。
- `DEFMT_LOG` が未設定だとログが表示されないことがあります。`info` 以上を推奨します。
- フラッシュエラー時は `programBinary` パスや `memory.x` の設定を確認してください。

## ライセンス

本リポジトリにライセンスは含めていません。必要に応じて追加してください。

***

開発メモ：コード内コメント・ドキュメントは日本語で統一しています。`cargo fmt --all` と `cargo clippy -D warnings` を通すことを推奨します。
